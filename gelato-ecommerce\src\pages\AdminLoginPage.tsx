import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { FaUser, FaLock, FaEye, FaEyeSlash, FaArrowLeft } from 'react-icons/fa';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-hot-toast';
import { useAuthStore } from '../store';
import { authAPI } from '../services/api';
import { LoginForm } from '../types';

const AdminLoginPage = () => {\n  const navigate = useNavigate();\n  const { login, isAuthenticated } = useAuthStore();\n  \n  const [formData, setFormData] = useState<LoginForm>({\n    username: '',\n    password: ''\n  });\n  \n  const [showPassword, setShowPassword] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [attempts, setAttempts] = useState(0);\n  const [lockUntil, setLockUntil] = useState<number | null>(null);\n\n  // å¦‚æœå·²ç¶“ç™»å…¥ï¼Œé‡å®šå‘åˆ°ç®¡ç†å¾Œå°\n  useEffect(() => {\n    if (isAuthenticated) {\n      navigate('/admin');\n    }\n  }, [isAuthenticated, navigate]);\n\n  // æª¢æŸ¥æ˜¯å¦è¢«é–å®š\n  useEffect(() => {\n    const checkLockStatus = () => {\n      if (lockUntil && Date.now() < lockUntil) {\n        const timeLeft = Math.ceil((lockUntil - Date.now()) / 1000);\n        if (timeLeft > 0) {\n          setTimeout(checkLockStatus, 1000);\n        } else {\n          setLockUntil(null);\n          setAttempts(0);\n        }\n      }\n    };\n    \n    if (lockUntil) {\n      checkLockStatus();\n    }\n  }, [lockUntil]);\n\n  const handleInputChange = (field: keyof LoginForm, value: string) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // æª¢æŸ¥æ˜¯å¦è¢«é–å®š\n    if (lockUntil && Date.now() < lockUntil) {\n      const timeLeft = Math.ceil((lockUntil - Date.now()) / 1000);\n      toast.error(`ç™»å…¥è¢«é–å®šï¼Œè«‹ç­‰å¾… ${timeLeft} ç§’å¾Œå†è©¦`);\n      return;\n    }\n    \n    if (!formData.username.trim() || !formData.password.trim()) {\n      toast.error('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');\n      return;\n    }\n    \n    setIsLoading(true);\n    \n    try {\n      const response = await authAPI.login(formData);\n      \n      if (response.success && response.data) {\n        // ç™»å…¥æˆåŠŸ\n        login(response.data.user);\n        localStorage.setItem('auth-token', response.data.token);\n        toast.success('ç™»å…¥æˆåŠŸï¼');\n        navigate('/admin');\n        \n        // é‡ç½®å˜—è©¦æ¬¡æ•¸\n        setAttempts(0);\n        setLockUntil(null);\n      } else {\n        // ç™»å…¥å¤±æ•—\n        const newAttempts = attempts + 1;\n        setAttempts(newAttempts);\n        \n        if (newAttempts >= 5) {\n          // é–å®š30åˆ†é˜\n          const lockTime = Date.now() + 30 * 60 * 1000;\n          setLockUntil(lockTime);\n          toast.error('ç™»å…¥å¤±æ•—æ¬¡æ•¸éå¤šï¼Œå¸³è™Ÿå·²è¢«é–å®š30åˆ†é˜');\n        } else {\n          toast.error(`å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ (${newAttempts}/5)`);\n        }\n      }\n    } catch (error) {\n      console.error('ç™»å…¥å¤±æ•—:', error);\n      \n      const newAttempts = attempts + 1;\n      setAttempts(newAttempts);\n      \n      if (newAttempts >= 5) {\n        const lockTime = Date.now() + 30 * 60 * 1000;\n        setLockUntil(lockTime);\n        toast.error('ç™»å…¥å¤±æ•—æ¬¡æ•¸éå¤šï¼Œå¸³è™Ÿå·²è¢«é–å®š30åˆ†é˜');\n      } else {\n        toast.error(`ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š (${newAttempts}/5)`);\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const isLocked = lockUntil && Date.now() < lockUntil;\n  const lockTimeLeft = isLocked ? Math.ceil((lockUntil! - Date.now()) / 1000) : 0;\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-pink-50 flex items-center justify-center px-4\">\n      {/* è¿”å›é¦–é æŒ‰éˆ• */}\n      <button\n        onClick={() => navigate('/')}\n        className=\"absolute top-6 left-6 flex items-center space-x-2 text-gray-600 hover:text-gray-800 transition-colors\"\n      >\n        <FaArrowLeft />\n        <span>è¿”å›é¦–é </span>\n      </button>\n\n      <motion.div\n        className=\"bg-white rounded-2xl shadow-xl p-8 w-full max-w-md\"\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.5 }}\n      >\n        {/* æ¨™é¡Œå€åŸŸ */}\n        <div className=\"text-center mb-8\">\n          <motion.div\n            className=\"text-6xl mb-4\"\n            initial={{ scale: 0 }}\n            animate={{ scale: 1 }}\n            transition={{ delay: 0.2, type: 'spring', stiffness: 200 }}\n          >\n            ğŸ¨\n          </motion.div>\n          <h1 className=\"text-2xl font-bold text-gray-800 mb-2\">\n            ç®¡ç†å“¡ç™»å…¥\n          </h1>\n          <p className=\"text-gray-600\">\n            æµ·æ°´ä¸å¯æ–—é‡ - å¾Œå°ç®¡ç†ç³»çµ±\n          </p>\n        </div>\n\n        {/* ç™»å…¥è¡¨å–® */}\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* å¸³è™Ÿè¼¸å…¥ */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              ç®¡ç†å“¡å¸³è™Ÿ\n            </label>\n            <div className=\"relative\">\n              <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\n                <FaUser className=\"text-gray-400\" />\n              </div>\n              <input\n                type=\"text\"\n                value={formData.username}\n                onChange={(e) => handleInputChange('username', e.target.value)}\n                disabled={isLocked || isLoading}\n                className=\"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed transition-colors\"\n                placeholder=\"è«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿ\"\n                required\n              />\n            </div>\n          </div>\n\n          {/* å¯†ç¢¼è¼¸å…¥ */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n              å¯†ç¢¼\n            </label>\n            <div className=\"relative\">\n              <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\n                <FaLock className=\"text-gray-400\" />\n              </div>\n              <input\n                type={showPassword ? 'text' : 'password'}\n                value={formData.password}\n                onChange={(e) => handleInputChange('password', e.target.value)}\n                disabled={isLocked || isLoading}\n                className=\"w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed transition-colors\"\n                placeholder=\"è«‹è¼¸å…¥å¯†ç¢¼\"\n                required\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword(!showPassword)}\n                disabled={isLocked || isLoading}\n                className=\"absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 disabled:cursor-not-allowed\"\n              >\n                {showPassword ? <FaEyeSlash /> : <FaEye />}\n              </button>\n            </div>\n          </div>\n\n          {/* éŒ¯èª¤æç¤º */}\n          {attempts > 0 && !isLocked && (\n            <motion.div\n              className=\"p-3 bg-yellow-50 border border-yellow-200 rounded-lg\"\n              initial={{ opacity: 0, height: 0 }}\n              animate={{ opacity: 1, height: 'auto' }}\n            >\n              <p className=\"text-sm text-yellow-700\">\n                âš ï¸ ç™»å…¥å¤±æ•— {attempts} æ¬¡ï¼Œé‚„æœ‰ {5 - attempts} æ¬¡æ©Ÿæœƒ\n              </p>\n            </motion.div>\n          )}\n\n          {/* é–å®šæç¤º */}\n          {isLocked && (\n            <motion.div\n              className=\"p-3 bg-red-50 border border-red-200 rounded-lg\"\n              initial={{ opacity: 0, height: 0 }}\n              animate={{ opacity: 1, height: 'auto' }}\n            >\n              <p className=\"text-sm text-red-700\">\n                ğŸ”’ å¸³è™Ÿå·²è¢«é–å®šï¼Œè«‹ç­‰å¾… {Math.floor(lockTimeLeft / 60)}:{(lockTimeLeft % 60).toString().padStart(2, '0')} å¾Œå†è©¦\n              </p>\n            </motion.div>\n          )}\n\n          {/* ç™»å…¥æŒ‰éˆ• */}\n          <button\n            type=\"submit\"\n            disabled={isLocked || isLoading || !formData.username.trim() || !formData.password.trim()}\n            className=\"w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors relative overflow-hidden\"\n          >\n            {isLoading ? (\n              <motion.div\n                className=\"flex items-center justify-center space-x-2\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n              >\n                <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                <span>ç™»å…¥ä¸­...</span>\n              </motion.div>\n            ) : isLocked ? (\n              `å·²é–å®š ${Math.floor(lockTimeLeft / 60)}:${(lockTimeLeft % 60).toString().padStart(2, '0')}`\n            ) : (\n              'ç™»å…¥ç®¡ç†å¾Œå°'\n            )}\n          </button>\n        </form>\n\n        {/* é è¨­å¸³å¯†æç¤º */}\n        <div className=\"mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg\">\n          <h3 className=\"text-sm font-medium text-gray-700 mb-2\">é è¨­ç™»å…¥è³‡è¨Šï¼š</h3>\n          <div className=\"text-sm text-gray-600 space-y-1\">\n            <p>å¸³è™Ÿï¼šadmin</p>\n            <p>å¯†ç¢¼ï¼šadmin123</p>\n            <p className=\"text-xs text-amber-600 mt-2\">\n              âš ï¸ å»ºè­°é¦–æ¬¡ç™»å…¥å¾Œç«‹å³æ›´æ”¹å¯†ç¢¼\n            </p>\n          </div>\n        </div>\n\n        {/* å®‰å…¨æç¤º */}\n        <div className=\"mt-4 text-center\">\n          <p className=\"text-xs text-gray-500\">\n            ç‚ºä¿éšœç³»çµ±å®‰å…¨ï¼Œé€£çºŒç™»å…¥å¤±æ•—5æ¬¡å°‡é–å®šå¸³è™Ÿ30åˆ†é˜\n          </p>\n        </div>\n      </motion.div>\n    </div>\n  );\n};\n\nexport default AdminLoginPage;"
